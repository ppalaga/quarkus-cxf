name: rebase-integration-branch
description: 'Rebase an integration branch such as quarkus-main, quarkus-3.15, cxf-main or cxf-4.0, rebuild it and report the status in a dedicated issue'

inputs:
  java-version:
    description: 'Java version'
    required: true
  base-branch:
    description: "The name of the branch in our git repository, such as main or 3.15, on top of which the given integration branch, such as quarkus-main, quarkus-3.15, cxf-main or cxf-4.0, should be rebased"
    required: true
    default: main
  integration-branch:
    description: "The name of the integration branch in our git repository, such as quarkus-main or quarkus-3.15, which should be rebased on top of the given base branch"
    required: true
    default: main
  dependency-git-repo-url:
    description: "The URL of the dependency's git repository to checkout and build from"
    required: true
  dependency-short-name:
    description: "The short lower case name of the dependency as quarkus or cxf"
    required: true
  dependency-branch:
    description: "The name of the dependency branch in the dependency git repository to build and test against, such as main or 3.15 for Quarkus or main or 4.0.x-fixes for CXF"
    required: true
    default: main
  issue-id:
    description: "The issue number where to report any rebase or build issues"
    required: true
  token:
    description: "The token to use to authenticate against GitHub API"
    required: true

outputs:
  dependency-commit:
    description: "The SHA1 of the branch specified in inputs.dependency-branch against which the current build was run"
    value: ${{ steps.rebuild-dependency.outputs.dependency-commit }}
  dependency-version:
    description: "The version of the dependency as present in the top pom.xml of its main branch"
    value: ${{ steps.rebuild-dependency.outputs.dependency-version }}
  upgrade-message:
    description: "The message of the commit upgrading the dependency version"
    value: ${{ steps.set-version.outputs.upgrade-message }}
  exit-status:
    description: |
      A short string describing how the execution went. 
      It can be one of the following:
        * success
        * rebase-failed
        * dependency-build-failed
    value: ${{ steps.rebase.outputs.exit-status != 'success' && steps.rebase.outputs.exit-status || steps.rebuild-dependency.outputs.exit-status }}

runs:
  using: 'composite'
  steps:

    - name: Set up JDK ${{ inputs.java-version }}
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: ${{ inputs.java-version }}

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: rebase ${{ inputs.integration-branch }}
      id: rebase
      shell: bash
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git fetch origin ${{ inputs.integration-branch }} \
            && git checkout ${{ inputs.integration-branch }} >/dev/null 2>&1 \
            || git checkout -b ${{ inputs.integration-branch }} origin/${{ inputs.base-branch }}
        git status
        echo "${{ inputs.integration-branch }}  is at $(git rev-parse HEAD)"
        git rebase ${{ inputs.base-branch }} 
        rebaseExitCode=$?
        echo "rebaseExitCode = $rebaseExitCode"
        echo "exit-status=$( [[ $rebaseExitCode == 0 ]] && echo 'success' || echo 'rebase-failed' )" >> $GITHUB_OUTPUT
        exit $rebaseExitCode

    - name: Reopen or comment on issue https://github.com/${{ github.repository }}/issues/${{ inputs.issue-id }}
      if: ${{ failure() }}
      shell: bash
      run: |
        oldState=$(gh issue view ${{ inputs.issue-id }} --json state -q .state -R ${{ github.repository }})
        echo "oldState = $oldState"
        msg="❌ Could not rebase ${{ inputs.integration-branch }} on top of ${{ inputs.base-branch }}}} in ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        if [[ "$oldState" == "OPEN" ]] ; then
          gh issue comment \
            --repo ${{ github.repository }} \
            --body "$msg" \
            ${{ inputs.issue-id }}
        else
          gh issue reopen \
            --repo ${{ github.repository }} \
            --comment "$msg" \
            ${{ inputs.issue-id }}
        fi
      env:
        GH_TOKEN: ${{ inputs.token }}

    - name: Rebuild ${{ inputs.dependency-git-repo-url }}
      uses: ./.github/actions/rebuild-dependency
      id: rebuild-dependency
      with:
        dependency-git-repo-url: ${{ inputs.dependency-git-repo-url }}
        dependency-short-name: ${{ inputs.dependency-short-name }}
        dependency-branch: ${{ inputs.dependency-branch }}
        issue-id: ${{ inputs.issue-id }}
        token: "${{ inputs.token }}"

    - name: Show steps.rebuild-dependency.outputs.exit-status
      if: ${{ !cancelled() }}
      shell: bash
      run: |
        echo "steps.rebuild-dependency.outputs.exit-status: ${{ steps.rebuild-dependency.outputs.exit-status }}"

    - name: Set ${{ inputs.dependency-short-name }}.version to ${{ steps.rebuild-dependency.outputs.dependency-version }}
      shell: bash
      id: set-version
      run: |
        upgradeMessage="Upgrade ${{ inputs.dependency-short-name }}.version to ${{ steps.rebuild-dependency.outputs.dependency-version }}"
        echo "upgrade-message=$(echo "$upgradeMessage")" >> $GITHUB_OUTPUT
        echo "pom.xml before:"
        cat pom.xml | head -n 50
        echo "Setting ${{ inputs.dependency-short-name }}.version = ${{ steps.rebuild-dependency.outputs.dependency-version }}"
        sed -i 's|<${{ inputs.dependency-short-name }}.version>[^<]*</${{ inputs.dependency-short-name }}.version>|<${{ inputs.dependency-short-name }}.version>${{ steps.rebuild-dependency.outputs.dependency-version }}</${{ inputs.dependency-short-name }}.version>|' pom.xml
        echo "pom.xml after:"
        cat pom.xml | head -n 50
        echo "git status before cq:sync-versions"
        git status
        if [ -n "$(git status --porcelain)" ]; then
          echo "The ${{ inputs.dependency-short-name }}.version change needs to get committed"
          ./mvnw cq:sync-versions -Dcq.simpleElementWhitespace=AUTODETECT_PREFER_SPACE -N -ntp
          git add -A
          echo "git status before commit"
          git status
          git commit -m "$upgradeMessage"
        else
          echo "The ${{ inputs.dependency-short-name }}.version change was already committed"
          ./mvnw cq:sync-versions -Dcq.simpleElementWhitespace=AUTODETECT_PREFER_SPACE -N -ntp
          if [ -n "$(git status --porcelain)" ]; then
            echo "./mvnw cq:sync-versions caused changes"
            git add -A
            echo "git status before commit"
            git status
            git commit -m "Re-run mvn cq:sync-versions"
          fi
        fi
        echo "git status after commit"
        git status
